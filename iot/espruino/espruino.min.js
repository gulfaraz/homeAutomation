"use strict";var wifi=require("Wifi"),tinyMQTT=require("tinyMQTT"),http=require("http"),flashEEPROM=require("FlashEEPROM"),switchList=[13,12],homeDefault={ssid:"",password:""},defaultDeviceId="//",configuration=function(e,t){function i(e){return void 0===s[e]&&(s[e]=new Uint8Array(0)),E.toString(s[e])}function n(){return{ssid:i(0),password:i(1)}}function r(){for(var t=[],n=2;n<e+2;n++){var r=i(n);r||(r=defaultDeviceId),t.push(r)}return t}var s=t.readAll(),o={};return o.client={ssid:"newDevice-"+wifi.getAPIP().mac.split(":").join(""),password:"setupnewdevice"},o.home=n(),o.mqtt={host:"10.244.66.28",port:1883,keepAlive:60},o.deviceIdList=r(),o.switchCount=e,o.save=function(e,i){t.erase(),t.write(0,e.ssid),t.write(1,e.password);for(var n in i){var r=i[n];t.write(2+n,r)}return this.home=e,this.deviceIdList=i,this},o}(switchList.length,new flashEEPROM);!function(e){function t(){setTimeout(require("ESP8266").reboot,f)}function i(e,t,i){wifi.stopAP(),console.log(t),wifi[e](t.ssid,{password:t.password},function(e){e||(s(),i())})}function n(i,n){if("POST"===i.method){var r="";i.on("data",function(s){s&&(r+=s),r.length==Number(i.headers["Content-Length"])&&(r=JSON.parse(r),e.save(r.homeCredentials,r.deviceIdList),n.writeHead(200),n.end("Configuration Saved"),t())})}else{n.writeHead(200);var s=url.parse(i.url,!0);if(s.query&&"i"in s.query){var o=switchList[s.query.i];digitalWrite(o,digitalRead(o)?0:1),n.end(JSON.stringify({state:digitalRead(o)}))}else n.end(JSON.stringify(e))}}function r(){http.createServer(n).listen(80)}function s(){for(var e in switchList)pinMode(switchList[e],"output"),digitalWrite(switchList[e],0)}function o(i,n){function r(i){digitalWrite(switchList[i],0),n[i]=defaultDeviceId;var r=n.map(function(e){return e.length}).reduce(function(e,t){return e+t},0)>defaultDeviceId.length*switchList.length?e.home:homeDefault;e.save(r,n),t()}function s(e,t){o.publish("State/"+e,1===digitalRead(t)?"on":"off")}var o=tinyMQTT.create(i.host);o.on("connected",function(){function e(e){o.subscribe("+/"+e),o.publish("Pair/"+e,"link")}for(var t in n){var i=n[t];i.length>defaultDeviceId.length&&setTimeout(e,(t+1)*l,i)}}),o.on("message",function(e){var t=e.topic.split("/"),i=t.shift(),o=t.join("/"),a=e.message.substring(2),c=n.map(function(e,t){return e==o?switchList[t]:0});for(var u in c){var d=c[u];d&&("Control"===i?(digitalWrite(d,"on"===a?1:0),s(o,d)):"Acknowledgement"===i?"failed"===a?r(u):"state"===a&&s(o,d):"Pair"===i&&"false"===a&&r(u))}}),o.on("disconnected",function(){o.connect()}),o.connect({port:i.port,keep_alive:i.keepAlive})}function a(){o(e.mqtt,e.deviceIdList)}var c=0,u=0,d=2,f=5e3,l=500;setWatch(function(i){console.log(u),i.time-c<d?(u+=i.time-i.lastTime,u>.001*f?(e.save(homeDefault,e.deviceIdList),t()):c=i.time):u=0,c=i.time},0,{repeat:!0,edge:"both",debounce:10});var h="startAP",v=e.client,p=r;e.home.ssid&&(h="connect",v=e.home,p=a),i(h,v,p)}(configuration);