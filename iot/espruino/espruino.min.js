"use strict";var wifi=require("Wifi"),tinyMQTT=require("tinyMQTT"),http=require("http"),flashEEPROM=require("FlashEEPROM"),switchList=[13],constant={index:{ssid:0,password:1,deviceId:2},state:{on:1,off:0,default:0},deviceIdLength:3},configuration=function(t,e){function i(t){return void 0===o[t]&&(o[t]=new Uint8Array(0)),E.toString(o[t])}function n(){return{ssid:i(constant.index.ssid),password:i(constant.index.password)}}function s(){for(var e=[],n=constant.index.deviceId;n<t+constant.index.deviceId;n++)e.push(i(n).split("/"));return e}var o=e.readAll(),r={};return r.client={ssid:"newDevice-"+wifi.getAPIP().mac.split(":").join(""),password:"setupnewdevice"},r.home=n(),r.mqtt={host:"10.244.193.33",port:1883,keepAlive:60},r.deviceIdList=s(),r.switchCount=t,r.save=function(t,i){e.erase(),e.write(constant.index.ssid,t.ssid),e.write(constant.index.password,t.password);for(var n in i){var s=i[n];e.write(constant.index.deviceId+n,s.join("/"))}return this.home=t,this.deviceIdList=i,this},r}(switchList.length,new flashEEPROM);!function(t){function e(){setTimeout(reset,u)}function i(t,e,i){wifi.stopAP(),console.log(e),wifi[t](e.ssid,{password:e.password},function(t){t||i()})}function n(i,n){if("POST"===i.method){var s="";i.on("data",function(o){o&&(s+=o),s.length==Number(i.headers["Content-Length"])&&(s=JSON.parse(s),t.save(s.homeCredentials,s.deviceIdList),n.writeHead(200),n.end("Configuration Saved"),e())})}else n.writeHead(200),n.end(JSON.stringify(t))}function s(){http.createServer(n).listen(80)}function o(){for(var t in switchList)pinMode(switchList[t],"output")}function r(i,n){function s(i){t.deviceIdList[i]=["","",""],t.save(t.home,t.deviceIdList),e()}function o(t,e){r.publish("State/"+t,1===digitalRead(switchList[e])?"on":"off")}var r=tinyMQTT.create(i.host);r.on("connected",function(){for(var t in n){var e=n[t];if(e.length>0){var i=e.join("/");r.subscribe("+/"+i),r.publish("Pair/"+i,"link")}}}),r.on("message",function(t){var e=t.topic.split("/"),i=e.shift(),r=e.join("/"),a=t.message.substring(2),c=n.map(function(t){return t.join("/")}).indexOf(r);if(c>=0)if("Control"===i){var d=constant.state.default;"on"!==a&&"off"!==a||(d=constant.state[a]),digitalWrite(switchList[c],d),o(r,c)}else"Acknowledgement"===i&&("failed"===a?s(c):"state"===a&&o(r,c))}),r.on("disconnected",function(){r.connect()}),r.connect({port:i.port,keep_alive:i.keepAlive})}function a(){o(),r(t.mqtt,t.deviceIdList)}var c=0,d=0,f=2,u=5e3;setWatch(function(i){console.log(d),i.time-c<f?(d+=i.time-i.lastTime,d>.001*u?(t.save({ssid:"",password:""},t.deviceIdList),e()):c=i.time):d=0,c=i.time},0,{repeat:!0,edge:"both",debounce:10});var v="startAP",h=t.client,l=s;t.home.ssid&&(v="connect",h=t.home,l=a),i(v,h,l)}(configuration);