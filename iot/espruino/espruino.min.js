"use strict";var wifi=require("Wifi"),tinyMQTT=require("tinyMQTT"),http=require("http"),flashEEPROM=require("FlashEEPROM"),switchList=[13],constant={index:{ssid:0,password:1,deviceId:2},state:{on:1,off:0,default:0},deviceIdLength:3},configuration=function(e,t){function i(e){return void 0===o[e]&&(o[e]=new Uint8Array(0)),E.toString(o[e])}function n(){return{ssid:i(constant.index.ssid),password:i(constant.index.password)}}function s(){for(var t=[],n=constant.index.deviceId;n<e+constant.index.deviceId;n++)t.push(i(n).split("/"));return t}var o=t.readAll(),r={};return r.client={ssid:"newDevice-"+wifi.getAPIP().mac.split(":").join(""),password:"setupnewdevice"},r.home=n(),r.mqtt={host:"10.244.193.33",port:1883,keepAlive:60},r.deviceIdList=s(),r.switchCount=e,r.save=function(e,i){t.erase(),t.write(constant.index.ssid,e.ssid),t.write(constant.index.password,e.password);for(var n in i){var s=i[n];t.write(constant.index.deviceId+n,s.join("/"))}return this.home=e,this.deviceIdList=i,this},r}(switchList.length,new flashEEPROM);!function(e){function t(){setTimeout(reset,u)}function i(e,t,i){wifi.stopAP(),console.log(t),wifi[e](t.ssid,{password:t.password},function(e){e||i()})}function n(i,n){if("POST"===i.method){var s="";i.on("data",function(o){o&&(s+=o),s.length==Number(i.headers["Content-Length"])&&(s=JSON.parse(s),e.save(s.homeCredentials,s.deviceIdList),n.writeHead(200),n.end("Configuration Saved"),t())})}else n.writeHead(200),n.end(JSON.stringify(e))}function s(){http.createServer(n).listen(80)}function o(){for(var e in switchList)pinMode(switchList[e],"output")}function r(i,n){function s(i){e.deviceIdList[i]=["","",""],e.save(e.home,e.deviceIdList),t()}var o=tinyMQTT.create(i.host);o.on("connected",function(){for(var e in n){var t=n[e];if(t.length>0){var i=t.join("/");o.subscribe("+/"+i),o.publish("Pair/"+i,"link")}}}),o.on("message",function(e){var t=e.topic.split("/"),i=t.shift(),o=t.join("/"),r=e.message.substring(2),c=n.map(function(e){return e.join("/")}).indexOf(o);if(c>=0)if("Control"===i){var a=constant.state.default;"on"!==r&&"off"!==r||(a=constant.state[r]),digitalWrite(switchList[c],a)}else"Acknowledgement"===i&&"failed"===r&&s(c)}),o.on("disconnected",function(){o.connect()}),o.connect({port:i.port,keep_alive:i.keepAlive})}function c(){o(),r(e.mqtt,e.deviceIdList)}var a=0,d=0,f=2,u=5e3;setWatch(function(i){console.log(d),i.time-a<f?(d+=i.time-i.lastTime,d>.001*u?(e.save({ssid:"",password:""},e.deviceIdList),t()):a=i.time):d=0,a=i.time},0,{repeat:!0,edge:"both",debounce:10});var v="startAP",h=e.client,l=s;e.home.ssid&&(v="connect",h=e.home,l=c),i(v,h,l)}(configuration);