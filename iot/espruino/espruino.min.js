"use strict";var wifi=require("Wifi"),tinyMQTT=require("tinyMQTT"),http=require("http"),flashEEPROM=require("FlashEEPROM"),switchList=[13,12],homeDefault={ssid:"",password:""},defaultDeviceId="//",configuration=function(e,t){function i(e){return void 0===o[e]&&(o[e]=new Uint8Array(0)),E.toString(o[e])}function n(){return{ssid:i(0),password:i(1)}}function r(){for(var t=[],n=2;n<e+2;n++){var r=i(n);r||(r=defaultDeviceId),t.push(r)}return t}var o=t.readAll(),s={};return s.client={ssid:"newDevice-"+wifi.getAPIP().mac.split(":").join(""),password:"setupnewdevice"},s.home=n(),s.mqtt={host:"raidms.com",port:1883,keepAlive:60},s.deviceIdList=r(),s.switchCount=e,s.save=function(e,i){t.erase(),t.write(0,e.ssid),t.write(1,e.password);for(var n in i){var r=i[n];t.write(2+n,r)}return this.home=e,this.deviceIdList=i,this},s}(switchList.length,new flashEEPROM);!function(configuration){function restartDevice(){setTimeout(require("ESP8266").reboot,resetTimeout)}function startNetwork(e,t,i){console.log(t),wifi[e](t.ssid,{password:t.password},i)}function webServer(e,t){var i="",n=url.parse(e.url,!0);if("POST"===e.method)e.on("data",function(n){n&&(i+=n),i.length==Number(e.headers["Content-Length"])&&(i=JSON.parse(i),configuration.save(i.homeCredentials,i.deviceIdList),t.writeHead(200),t.end("Configuration Saved"),restartDevice())});else if("PUT"===e.method)e.on("data",function(r){r&&(i+=r),i.length==Number(e.headers["Content-Length"])&&(n.query&&"s"in n.query?wifi.scan(function(e){t.writeHead(200),t.end(JSON.stringify(e))}):(i=JSON.parse(i),setTimeout(function(){t.close||(t.writeHead(500),t.end("Failed to connect to network"))},networkTimeout),startNetwork("connect",i,function(e){e||(t.writeHead(200),t.end("Connected to network"))})))});else if(t.writeHead(200),n.query&&"i"in n.query){var r=switchList[n.query.i];digitalWrite(r,digitalRead(r)?0:1),t.end(JSON.stringify({state:digitalRead(r)}))}else t.end(JSON.stringify(configuration))}function initializeSwitches(){for(var e in switchList)pinMode(switchList[e],"output"),digitalWrite(switchList[e],0)}function startWebServer(e){e?restartDevice():(initializeSwitches(),http.createServer(webServer).listen(80))}function connectToMQTTServer(e,t){function i(e){digitalWrite(switchList[e],0),t[e]=defaultDeviceId;var i=t.map(function(e){return e.length}).reduce(function(e,t){return e+t},0)>defaultDeviceId.length*switchList.length?configuration.home:homeDefault;configuration.save(i,t),restartDevice()}function n(e,t){r.publish("State/"+e,1===digitalRead(t)?"on":"off")}var r=tinyMQTT.create(e.host);r.on("connected",function(){function e(e){r.subscribe("+/"+e),r.publish("Pair/"+e,"link")}for(var i in t){var n=t[i];n.length>defaultDeviceId.length&&setTimeout(e,(i+1)*subscribeTimeout,n)}}),r.on("message",function(e){var r=e.topic.split("/"),o=r.shift(),s=r.join("/"),a=e.message.substring(2),c=t.map(function(e,t){return e==s?switchList[t]:0});for(var u in c){var d=c[u];d&&("Control"===o?(digitalWrite(d,"on"===a?1:0),n(s,d)):"Acknowledgement"===o?"failed"===a?i(u):"state"===a&&n(s,d):"Pair"===o&&"false"===a&&i(u))}}),r.on("disconnected",function(){r.connect()}),r.connect({port:e.port,keep_alive:e.keepAlive})}function setupMQTTClient(){connectToMQTTServer(configuration.mqtt,configuration.deviceIdList)}function fetchFirmware(error){error?startNetwork("startAP",configuration.client,startWebServer):(initializeSwitches(),http.get("http://"+configuration.mqtt.host+":8080/device/firmware",function(response){var data="";response.on("data",function(e){data.length<firmwareMaxLength&&(data+=e)}),response.on("close",function(){data=JSON.parse(data);try{eval(data.firmware)}catch(e){setupMQTTClient()}})}))}var lastPress=0,timer=0,pressTimeout=2,resetTimeout=5e3,subscribeTimeout=500,firmwareMaxLength=3e3,networkTimeout=3e4;setWatch(function(e){console.log(timer),e.time-lastPress<pressTimeout?(timer+=e.time-e.lastTime,timer>.001*resetTimeout?(configuration.save(homeDefault,configuration.deviceIdList),restartDevice()):lastPress=e.time):timer=0,lastPress=e.time},0,{repeat:!0,edge:"both",debounce:10}),wifi.stopAP();var mode="startAP",credentials=configuration.client,next=startWebServer;configuration.home.ssid&&(mode="connect",credentials=configuration.home,next=fetchFirmware),startNetwork(mode,credentials,next)}(configuration);