var wifi=require("Wifi"),tinyMQTT=require("tinyMQTT"),http=require("http"),flashEEPROM=require("FlashEEPROM"),switchList=[13],constant={index:{ssid:0,password:1,deviceId:2},offset:{homeId:0,roomId:1,terminalId:2},state:{on:1,off:0,default:0},deviceIdLength:3},configuration=function(t,e){function n(t){return void 0===s[t]&&(s[t]=new Uint8Array(0)),E.toString(s[t])}function i(){return{ssid:n(constant.index.ssid),password:n(constant.index.password)}}function o(){for(var e=[],i=0;i<t;i++){var o=i*constant.deviceIdLength+constant.index.deviceId;e.push([n(o+constant.offset.homeId),n(o+constant.offset.roomId),n(o+constant.offset.terminalId)])}return e}var s=e.readAll(),a={};return a.client={ssid:"newDevice-"+wifi.getAPIP().mac.split(":").join(""),password:"setupnewdevice"},a.home=i(),a.mqtt={host:"10.244.214.50",port:1883,keepAlive:60},a.deviceIdList=o(),a.switchCount=t,a.save=function(t,n){e.erase(),e.write(constant.index.ssid,t.ssid),e.write(constant.index.password,t.password);for(var i in n){var o=i*constant.deviceIdLength+constant.index.deviceId,s=n[i];e.write(o+constant.offset.homeId,s[constant.offset.homeId]),e.write(o+constant.offset.roomId,s[constant.offset.roomId]),e.write(o+constant.offset.terminalId,s[constant.offset.terminalId])}return this.home=t,this.deviceIdList=n,this},a}(switchList.length,new flashEEPROM);!function(t){function e(){setTimeout(reset,f)}function n(t,e,n){wifi.stopAP(),console.log(e),wifi[t](e.ssid,{password:e.password},function(t){t||n()})}function i(n,i){if("POST"===n.method){var o="";n.on("data",function(s){s&&(o+=s),o.length==Number(n.headers["Content-Length"])&&(o=JSON.parse(o),t.save(o.homeCredentials,o.deviceIdList),i.writeHead(200),i.end("Configuration Saved"),e())})}else i.writeHead(200),i.end(JSON.stringify(t))}function o(){http.createServer(i).listen(80)}function s(n,i){function o(n){t.deviceIdList[n]=["","",""],t.save(t.home,t.deviceIdList),e()}function s(t,e){var n=-1;for(var i in t)if(t[i][constant.offset.terminalId]==e){n=i;break}return n}var a=tinyMQTT.create(n.host);a.on("connected",function(){for(var t in i){var e=i[t];e[constant.offset.terminalId].length>0&&(a.subscribe("+/"+e[constant.offset.terminalId]),a.publish("Pair/"+e[constant.offset.terminalId],e[constant.offset.homeId]+"/"+e[constant.offset.roomId]))}}),a.on("message",function(t){var e=t.topic.split("/"),n=e[0],a=e[1],r=t.message.substring(2),d=s(i,a);if("Control"===n){var c=constant.state.default;"on"!==r&&"off"!==r||(c=constant.state[r]),digitalWrite(switchList[d],c)}else"Acknowledgement"===n&&"failed"===r&&o(d)}),a.on("disconnected",function(){a.connect()}),a.connect({port:n.port,keep_alive:n.keepAlive})}function a(){s(t.mqtt,t.deviceIdList)}var r=0,d=0,c=2,f=5e3;setWatch(function(n){console.log(d),n.time-r<c?(d+=n.time-n.lastTime,d>.001*f?(t.save({ssid:"",password:""},t.deviceIdList),e()):r=n.time):d=0,r=n.time},0,{repeat:!0,edge:"both",debounce:10});var u="startAP",v=t.client,h=o;t.home.ssid&&(u="connect",v=t.home,h=a),n(u,v,h)}(configuration);