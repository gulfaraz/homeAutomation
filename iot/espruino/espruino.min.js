"use strict";var wifi=require("Wifi"),tinyMQTT=require("tinyMQTT"),http=require("http"),flashEEPROM=require("FlashEEPROM"),switchList=[13,12],homeDefault={ssid:"",password:""},defaultDeviceId="//",configuration=function(e,t){function i(e){return void 0===s[e]&&(s[e]=new Uint8Array(0)),E.toString(s[e])}function n(){return{ssid:i(0),password:i(1)}}function o(){for(var t=[],n=2;n<e+2;n++){var o=i(n);o||(o=defaultDeviceId),t.push(o)}return t}var s=t.readAll(),r={};return r.client={ssid:"newDevice-"+wifi.getAPIP().mac.split(":").join(""),password:"setupnewdevice"},r.home=n(),r.mqtt={host:"10.244.46.200",port:1883,keepAlive:60},r.deviceIdList=o(),r.switchCount=e,r.save=function(e,i){t.erase(),t.write(0,e.ssid),t.write(1,e.password);for(var n in i){var o=i[n];t.write(2+n,o)}return this.home=e,this.deviceIdList=i,this},r}(switchList.length,new flashEEPROM);!function(e){function t(){setTimeout(require("ESP8266").reboot,f)}function i(e,t,i){wifi.stopAP(),console.log(t),wifi[e](t.ssid,{password:t.password},function(e){e||i()})}function n(i,n){if("POST"===i.method){var o="";i.on("data",function(s){s&&(o+=s),o.length==Number(i.headers["Content-Length"])&&(o=JSON.parse(o),e.save(o.homeCredentials,o.deviceIdList),n.writeHead(200),n.end("Configuration Saved"),t())})}else n.writeHead(200),n.end(JSON.stringify(e))}function o(){http.createServer(n).listen(80)}function s(){for(var e in switchList)pinMode(switchList[e],"output"),digitalWrite(switchList[e],0)}function r(i,n){function o(i){digitalWrite(switchList[i],0),n[i]=defaultDeviceId;var o=n.map(function(e){return e.length}).reduce(function(e,t){return e+t},0)>defaultDeviceId.length*switchList.length?e.home:homeDefault;e.save(o,n),t()}function s(e,t){r.publish("State/"+e,1===digitalRead(t)?"on":"off")}var r=tinyMQTT.create(i.host);r.on("connected",function(){function e(e){r.subscribe("+/"+e),r.publish("Pair/"+e,"link")}for(var t in n){var i=n[t];i.length>defaultDeviceId.length&&setTimeout(e,(t+1)*l,i)}}),r.on("message",function(e){var t=e.topic.split("/"),i=t.shift(),r=t.join("/"),a=e.message.substring(2),c=n.map(function(e,t){return e==r?switchList[t]:0});for(var u in c){var d=c[u];d&&("Control"===i?(digitalWrite(d,"on"===a?1:0),s(r,d)):"Acknowledgement"===i?"failed"===a?o(u):"state"===a&&s(r,d):"Pair"===i&&"false"===a&&o(u))}}),r.on("disconnected",function(){r.connect()}),r.connect({port:i.port,keep_alive:i.keepAlive})}function a(){s(),r(e.mqtt,e.deviceIdList)}var c=0,u=0,d=2,f=5e3,l=500;setWatch(function(i){console.log(u),i.time-c<d?(u+=i.time-i.lastTime,u>.001*f?(e.save(homeDefault,e.deviceIdList),t()):c=i.time):u=0,c=i.time},0,{repeat:!0,edge:"both",debounce:10});var h="startAP",v=e.client,p=o;e.home.ssid&&(h="connect",v=e.home,p=a),i(h,v,p)}(configuration);